name: Green CI/CD Pipeline

on:
  push:
    branches: ["main", "master"]
  pull_request:
    branches: ["main", "master"]

jobs:
  # --- JOB 1: INTEGRATION, TESTING & SUSTAINABILITY (CI) ---
  integration-and-sustainability:
    runs-on: ubuntu-latest
    steps:
      # 1. Setup Base
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: "21"
          distribution: "temurin"
          cache: "maven"

      # 2. Build e Unit Test Classici
      - name: Build with Maven
        run: mvn clean install -DskipTests

      - name: Run Unit Tests
        run: mvn test

      # 3. Micro-benchmark sul codice (JMH)
      - name: Run JMH Benchmarks
        run: mvn exec:java -Dexec.mainClass=benchmark.JmhRunner -Dexec.classpathScope=test

      # 4. Setup Ambiente di Integrazione
      - name: Set up Docker Compose
        run: docker compose up -d --build

      - name: Wait for Application
        run: |
          echo "Waiting for app to start on localhost:8080..."
          timeout 60s bash -c 'until curl -s http://localhost:8080 > /dev/null; do sleep 5; done'
          echo "App is up and running!"

      # 5. Load Testing (JMeter)
      - name: Run JMeter Tests
        run: |
          chmod -R 777 jmeter || true
          docker run --rm --network host \
            -v ${{ github.workspace }}/jmeter:/jmeter \
            -w /jmeter \
            justb4/jmeter \
            -n -t Scenario_A_Anonymous.jmx -l result_A.jtl

      # 6. GreenIT Analysis (Include EcoIndex Score nel report HTML)
      - name: Build & Run GreenIT Analysis
        run: |
          # Clone e build da sorgente (piÃ¹ sicuro)
          git clone https://github.com/cnumr/GreenIT-Analysis-cli.git greenit-repo
          cd greenit-repo
          docker build -t local-greenit-analysis .
          cd ..

          # Creazione file di configurazione
          echo "- url: http://localhost:8080" > urls_to_scan.yaml

          # Preparazione cartella output
          mkdir -p reports/greenit
          chmod 777 reports/greenit

          # Esecuzione analisi
          docker run --rm --network host \
            -v $(pwd):/scan \
            local-greenit-analysis \
            greenit analyse /scan/urls_to_scan.yaml /scan/reports/greenit/report.html

      # 7. Salvataggio Report
      - name: Upload Test Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: green-performance-reports
          path: |
            jmeter/result_A.jtl
            reports/

      # 8. Pulizia
      - name: Stop Docker Compose
        if: always()
        run: docker compose down

  # --- JOB 2: DELIVERY SU DOCKER HUB (CD) ---
  build_and_push_docker:
    needs: integration-and-sustainability
    runs-on: ubuntu-latest
    # Deploy solo su merge su main/master
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'

    steps:
      - uses: actions/checkout@v4

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Extract Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ secrets.DOCKERHUB_USERNAME }}/ac-gainz-sustainability

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
