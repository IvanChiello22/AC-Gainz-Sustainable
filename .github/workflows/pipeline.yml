name: Green CI/CD Pipeline (All-in-One)

on:
  push:
    branches: ["main", "master"]
  pull_request:
    branches: ["main", "master"]

jobs:
  # --- JOB 1: INTEGRATION, TESTING & SUSTAINABILITY (CI) ---
  integration-and-sustainability:
    runs-on: ubuntu-latest
    timeout-minutes: 20 # SonarQube è lento ad avviarsi

    steps:
      # 1. Setup Base
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: "21"
          distribution: "temurin"
          cache: "maven"

      # 2. Build e Unit Test
      - name: Build with Maven
        run: mvn clean install -DskipTests

      - name: Run Unit Tests
        run: mvn test

      # --- STEP 3: SONARQUBE + PLUGIN CREEDENGO (EcoCode) ---
      - name: Setup & Start SonarQube with Creedengo Rules
        run: |
          echo "Scaricamento Plugin Creedengo (EcoCode)..."
          mkdir -p sonar-plugins

          # SCARICHIAMO IL PLUGIN UFFICIALE CHE CONTIENE LE REGOLE CREEDENGO
          # Link alla release ufficiale Green Code Initiative
          wget -O sonar-plugins/ecoCode.jar https://github.com/green-code-initiative/ecoCode/releases/download/3.1.1/ecoCode-sonar-plugin-3.1.1.jar

          echo "Avvio Container SonarQube..."
          # Montiamo il plugin direttamente all'avvio per non dover riavviare dopo
          docker run -d --name sonarqube \
            -p 9000:9000 \
            -v $(pwd)/sonar-plugins:/opt/sonarqube/extensions/plugins \
            sonarqube:community

          echo "Attesa avvio SonarQube (circa 2-3 min)..."
          # Attendiamo che SonarQube sia completamente operativo
          timeout 300s bash -c 'until curl -s http://localhost:9000/api/system/status | grep -q "\"status\":\"UP\""; do sleep 5; done'
          echo "SonarQube è pronto!"

          echo "Configurazione Profilo Green..."
          # 1. Autenticazione: cambio password default
          curl -u admin:admin -X POST "http://localhost:9000/api/users/change_password?login=admin&previousPassword=admin&password=admin123"

          # 2. Attivazione Regole: Impostiamo il profilo "EcoCode Way" (regole Creedengo) come default
          curl -u admin:admin123 -X POST "http://localhost:9000/api/qualityprofiles/set_default?language=java&qualityProfile=EcoCode%20Way"

      - name: Run SonarQube Analysis
        # Colleghiamo Maven al SonarQube locale temporaneo
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: "admin123"
          SONAR_HOST_URL: "http://localhost:9000"
        run: |
          mvn org.sonarsource.scanner.maven:sonar-maven-plugin:sonar \
            -Dsonar.login=admin \
            -Dsonar.password=admin123 \
            -Dsonar.qualitygate.wait=true

      # 4. Micro-benchmark (JMH)
      - name: Run JMH Benchmarks
        run: mvn exec:java -Dexec.mainClass=benchmark.JmhRunner -Dexec.classpathScope=test

      # 5. Setup Ambiente Docker (App Locale)
      - name: Set up Docker Compose
        run: docker compose up -d --build

      - name: Wait for Application
        run: |
          echo "Waiting for app on localhost:8080..."
          timeout 60s bash -c 'until curl -s http://localhost:8080 > /dev/null; do sleep 5; done'
          echo "App is up!"

      # 6. Load Testing (JMeter)
      - name: Run JMeter Tests
        run: |
          chmod -R 777 jmeter || true
          docker run --rm --network host \
            -v ${{ github.workspace }}/jmeter:/jmeter \
            -w /jmeter \
            justb4/jmeter \
            -n -t Scenario_A_Anonymous.jmx -l result_A.jtl

      # 7. GreenIT Analysis (Build from source)
      - name: Build & Run GreenIT Analysis
        run: |
          git clone https://github.com/cnumr/GreenIT-Analysis-cli.git greenit-repo
          cd greenit-repo
          docker build -t local-greenit-analysis .
          cd ..

          echo "- url: http://localhost:8080" > urls_to_scan.yaml
          mkdir -p reports/greenit
          chmod 777 reports/greenit

          docker run --rm --network host \
            -v $(pwd):/scan \
            local-greenit-analysis \
            greenit analyse /scan/urls_to_scan.yaml /scan/reports/greenit/report.html

      # 8. Salvataggio Report
      - name: Upload Test Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: green-performance-reports
          path: |
            jmeter/result_A.jtl
            reports/

      # 9. Pulizia
      - name: Stop Docker Compose
        if: always()
        run: docker compose down

  # --- JOB 2: DELIVERY SU DOCKER HUB (CD) ---
  build_and_push_docker:
    needs: integration-and-sustainability
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'

    steps:
      - uses: actions/checkout@v4

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Extract Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ secrets.DOCKERHUB_USERNAME }}/ac-gainz-sustainability

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
