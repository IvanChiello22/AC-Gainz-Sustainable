name: Green CI/CD Pipeline

on:
  push:
    branches: ["main", "master"]
  pull_request:
    branches: ["main", "master"]

jobs:
  # --- JOB 1: INTEGRATION, TESTING & SUSTAINABILITY (CI) ---
  integration-and-sustainability:
    runs-on: ubuntu-latest
    steps:
      # 1. Setup Base
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: "21"
          distribution: "temurin"
          cache: "maven"

      # 2. Build e Unit Test Classici
      - name: Build with Maven
        run: mvn clean install -DskipTests

      - name: Run Unit Tests
        run: mvn test

      # 3. Micro-benchmark sul codice (JMH)
      - name: Run JMH Benchmarks
        # Esegue la classe runner JMH definita nel progetto
        run: mvn exec:java -Dexec.mainClass=benchmark.JmhRunner -Dexec.classpathScope=test

      # 4. Setup Ambiente di Integrazione (Applicazione live)
      - name: Set up Docker Compose
        # Avvia l'app + eventuali DB definiti nel docker-compose.yml
        run: docker compose up -d --build

      - name: Wait for Application
        run: |
          echo "Waiting for app to start on localhost:8080..."
          timeout 60s bash -c 'until curl -s http://localhost:8080 > /dev/null; do sleep 5; done'
          echo "App is up and running!"

      # 5. Load Testing (JMeter)
      - name: Run JMeter Tests
        # Monta la cartella locale 'jmeter' dentro il container per leggere il .jmx e salvare il report
        run: |
          # Assicurati che la cartella 'jmeter' esista e sia scrivibile
          chmod -R 777 jmeter || true

          docker run --rm --network host \
            -v ${{ github.workspace }}/jmeter:/jmeter \
            -w /jmeter \
            justb4/jmeter \
            -n -t Scenario_A_Anonymous.jmx -l result_A.jtl

      # 4. GreenIT Analysis - COSTRUITA E CORRETTA
      - name: Build & Run GreenIT Analysis
        run: |
          git clone https://github.com/cnumr/GreenIT-Analysis-cli.git greenit-repo
          cd greenit-repo
          docker build -t local-greenit-analysis .
          cd ..

          echo "- url: http://localhost:8080" > urls_to_scan.yaml

          mkdir -p reports/greenit
          chmod 777 reports/greenit

          docker run --rm --network host \
            -v $(pwd):/scan \
            local-greenit-analysis \
            greenit analyse /scan/urls_to_scan.yaml /scan/reports/greenit/report.html

      # 7. EcoIndex (Score Sostenibilità)
      - name: Run EcoIndex Analysis
        run: |
          docker run --rm --network host \
            -v $(pwd):/app/reports \
            vvatelot/ecoindex-cli \
            ecoindex-cli analyze --url http://localhost:8080 --output /app/reports/ecoindex.json

      # 8. Salvataggio Report (Fondamentale per vedere i risultati)
      - name: Upload Test Reports
        uses: actions/upload-artifact@v4
        if: always() # Esegui anche se i test falliscono per vedere cosa è successo
        with:
          name: green-performance-reports
          path: |
            jmeter/result_A.jtl
            reports/
            ecoindex.json

      # 9. Pulizia
      - name: Stop Docker Compose
        if: always()
        run: docker compose down

  # --- JOB 2: DELIVERY SU DOCKER HUB (CD) ---
  build_and_push_docker:
    # Parte solo se 'integration-and-sustainability' è verde
    needs: integration-and-sustainability
    runs-on: ubuntu-latest
    # Esegue il push solo se siamo sul branch main (o master), non sulle PR
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'

    steps:
      - uses: actions/checkout@v4

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Extract Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ secrets.DOCKERHUB_USERNAME }}/ac-gainz-sustainability

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
